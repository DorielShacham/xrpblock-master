<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="favicon/favicon-32x32.png">
    <title>XRPBlock</title>
    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-WP6CPTJ7');</script>
    <!-- End Google Tag Manager -->
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-HM3N402YPM"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-HM3N402YPM');
    </script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1723436791336055"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Markazi+Text:wght@400..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://xaman.app/assets/cdn/xumm.min.js"></script>
    <style>
        * {
            font-family: 'Markazi Text', serif;
        }
    </style>
</head>

<body>

    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WP6CPTJ7" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <form id="walletForm">
        <label id="wallet__title" for="wallet__input">XRP Wallet Address:</label>
        <input id="wallet__input" type="text" placeholder="Enter XRP wallet address" required>
        <br>
        <button id="wallet__btn" type="submit">Check Wallet</button>
        <br>
        <button type="button" id="xaman-login-btn"
            style="margin-top:1rem;background:#3052ff;color:white;border-radius:6px;padding:10px 20px;cursor:pointer; font-size: x-large;">
            Login with Xaman (Xumm)
        </button>
    </form>
    <div id="xaman-status" style="text-align:center;margin-top:10px;color:#3052ff;"></div>

    <script>
        document.getElementById("walletForm").addEventListener("submit", (e) => {
            e.preventDefault();
            const walletAddress = document.getElementById("wallet__input").value.trim();
            if (walletAddress) {
                sessionStorage.setItem("walletAddress", walletAddress);
                window.location.href = `dashboard.html?q=${encodeURIComponent(walletAddress)}`;
            } else {
                alert("Please enter a valid XRP wallet address.");
            }
        });
    </script>

    <!-- Xaman (Xumm) integration -->
    <script>
        var xumm = new Xumm("bb92bf0f-5442-4498-a1f6-cdcbe058e825");

        xumm.on("ready", async () => {
            const storedWalletId = sessionStorage.getItem('walletId');

            if (!storedWalletId) {
                // Only fetch and store the wallet address if it's not already stored
                xumm.user.account.then(account => {
                    document.getElementById('wallet__input').value = account;
                    sessionStorage.setItem('walletId', account);
                    sessionStorage.setItem('walletAddress', account);
                    document.getElementById('xaman-status').innerText = "Wallet connected! Redirecting...";
                    // Redirect to dashboard after a short delay
                    setTimeout(() => {
                        window.location.href = `dashboard.html?q=${encodeURIComponent(account)}`;
                    }, 1500);
                });
            } else {
                console.log("User already logged in with wallet ID:", storedWalletId);
                // Render the already stored wallet ID
                document.getElementById('wallet__input').value = storedWalletId;
                document.getElementById('xaman-status').innerText = "Wallet connected!";
            }
        });

        xumm.on("success", async () => {
            xumm.user.account.then(account => {
                const walletAddress = account;
                document.getElementById('wallet__input').value = walletAddress;
                sessionStorage.setItem('walletId', account);
                sessionStorage.setItem('walletAddress', account);
                document.getElementById('xaman-status').innerText = "Wallet connected! Redirecting...";
                // Redirect to dashboard after a short delay
                setTimeout(() => {
                    window.location.href = `dashboard.html?q=${encodeURIComponent(walletAddress)}`;
                }, 1500);
            });
        });

        xumm.on("logout", async () => {
            sessionStorage.removeItem('walletId');
            sessionStorage.removeItem('walletAddress');
            document.getElementById('wallet__input').value = '';
            document.getElementById('xaman-status').innerText = "Logged out.";
        });

        document.getElementById('xaman-login-btn').addEventListener('click', function () {
            xumm.authorize();
            document.getElementById('xaman-status').innerText = "Scan the QR code with your Xaman app...";
        });
    </script>

</body>

</html>